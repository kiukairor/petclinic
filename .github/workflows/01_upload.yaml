name: Publish to Artifactory

on:
  workflow_run:
    workflows: ["Build, Test and Package"]
    types:
      - completed
permissions:
  id-token: write

jobs:
  upload:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-artifact  # Matches the uploaded name
          path: artifact-dir/  # Different directory to avoid conflicts

      - name: Verify artifact
        run: |
          echo "Downloaded files:"
          ls -la artifact-dir/
          echo "Unzipping..."
          unzip artifact-dir/app-artifact.zip -d target/
          ls -la target/

      - name: Set up  Artifactory
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://trial3sr477.jfrog.io
        with:
          oidc-provider-name: github-jfrog
          oidc-audience: my-aud
        
      - name: Upload to Artifactory  
        run: jf rt upload --url="$JF_URL" "target/*.jar" "petclinic-libs-snapshot-local/"